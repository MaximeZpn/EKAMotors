<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test Vente - EKA Motors</title>
    <style>
        body { font-family: Arial, sans-serif; padding: 20px; background: #f5f5f5; }
        .container { max-width: 1000px; margin: 0 auto; background: white; padding: 20px; border-radius: 8px; }
        button { padding: 10px 15px; margin: 5px; background: #4a90e2; color: white; border: none; border-radius: 4px; cursor: pointer; }
        button:hover { background: #357abd; }
        button:disabled { background: #ccc; cursor: not-allowed; }
        table { width: 100%; border-collapse: collapse; margin: 20px 0; }
        th, td { border: 1px solid #ddd; padding: 10px; text-align: left; }
        th { background: #f4f4f4; }
        tr:hover { background: #f9f9f9; }
        tr.selected { background: #e3f2fd; }
        .details { background: #f9f9f9; padding: 20px; margin: 20px 0; border-radius: 8px; }
        input[type="number"] { padding: 8px; border: 1px solid #ddd; border-radius: 4px; }
        .success { color: green; font-weight: bold; }
        .error { color: red; font-weight: bold; }
    </style>
</head>
<body>
    <div class="container">
        <h1>üöó Test Vente de V√©hicules</h1>
        
        <button onclick="window.location.href='/'">‚¨Ö Accueil</button>
        <button onclick="window.location.href='/catalogue.html'">üîç Catalogue</button>
        <button onclick="testerAPIs()">üîß Tester APIs</button>
        
        <h2>Mes v√©hicules</h2>
        <table id="vehiculesTable">
            <thead>
                <tr><th>ID</th><th>Nom</th><th>Description</th><th>Prix</th><th>En vente</th></tr>
            </thead>
            <tbody>
                <tr><td colspan="5">Chargement...</td></tr>
            </tbody>
        </table>
        
        <div class="details" id="details" style="display:none;">
            <h3>Mettre en vente</h3>
            <p><strong>V√©hicule s√©lectionn√©:</strong> <span id="selectedName">-</span></p>
            <p>
                <label>Prix de vente: </label>
                <input type="number" id="prixVente" placeholder="15000" min="1" step="100">
                <span> $</span>
            </p>
            <button onclick="vendreVehicule()">üí∞ Mettre en vente</button>
            <div id="message"></div>
        </div>
        
        <div id="logs" style="background: #f0f0f0; padding: 10px; margin: 20px 0; border-radius: 4px; font-family: monospace; font-size: 12px; white-space: pre-wrap;"></div>
    </div>

    <script>
        let selectedVehicule = null;
        const userId = 1; // ID utilisateur fixe pour test
        
        // Fonction de log
        function log(message) {
            console.log(message);
            document.getElementById('logs').textContent += new Date().toLocaleTimeString() + ': ' + message + '\n';
        }
        
        // Chargement initial
        document.addEventListener('DOMContentLoaded', function() {
            log('üöó Page de test charg√©e');
            chargerVehicules();
        });
        
        // Charger les v√©hicules
        async function chargerVehicules() {
            log('üì• Chargement des v√©hicules...');
            
            try {
                const response = await fetch(`/api/cartes/utilisateur/${userId}`);
                log(`üì• R√©ponse API v√©hicules: ${response.status}`);
                
                if (response.ok) {
                    const vehicules = await response.json();
                    log(`‚úÖ ${vehicules.length} v√©hicules trouv√©s`);
                    afficherVehicules(vehicules);
                } else {
                    log(`‚ùå Erreur chargement v√©hicules: ${response.status}`);
                }
            } catch (error) {
                log(`‚ùå Erreur r√©seau: ${error.message}`);
            }
        }
        
        // Afficher les v√©hicules
        function afficherVehicules(vehicules) {
            const tbody = document.querySelector('#vehiculesTable tbody');
            
            if (vehicules.length === 0) {
                tbody.innerHTML = '<tr><td colspan="5">Aucun v√©hicule</td></tr>';
                return;
            }
            
            tbody.innerHTML = vehicules.map(v => `
                <tr onclick="selectionnerVehicule(${v.id}, '${v.nom}', ${v.avendre})" style="cursor: pointer;">
                    <td>${v.id}</td>
                    <td>${v.nom}</td>
                    <td>${v.description}</td>
                    <td>${v.prix} $</td>
                    <td>${v.avendre ? 'üè∑Ô∏è Oui' : '‚úÖ Non'}</td>
                </tr>
            `).join('');
        }
        
        // S√©lectionner un v√©hicule
        function selectionnerVehicule(id, nom, enVente) {
            // D√©s√©lectionner les autres
            document.querySelectorAll('#vehiculesTable tr').forEach(r => r.classList.remove('selected'));
            event.target.closest('tr').classList.add('selected');
            
            selectedVehicule = { id, nom, enVente };
            document.getElementById('selectedName').textContent = nom;
            document.getElementById('details').style.display = 'block';
            
            if (enVente) {
                document.getElementById('message').innerHTML = '<p class="error">Ce v√©hicule est d√©j√† en vente</p>';
            } else {
                document.getElementById('message').innerHTML = '';
            }
            
            log(`üéØ V√©hicule s√©lectionn√©: ${nom} (ID: ${id})`);
        }
        
        // Vendre un v√©hicule
        async function vendreVehicule() {
            if (!selectedVehicule) {
                alert('S√©lectionnez un v√©hicule');
                return;
            }
            
            const prix = document.getElementById('prixVente').value;
            if (!prix || prix <= 0) {
                alert('Entrez un prix valide');
                return;
            }
            
            // D'abord, v√©rifier que la carte existe bien
            log(`üîç V√©rification existence carte ID ${selectedVehicule.id}...`);
            document.getElementById('message').innerHTML = '<p>V√©rification du v√©hicule...</p>';
            
            try {
                const checkResponse = await fetch(`/api/cartes/${selectedVehicule.id}`);
                log(`üîç V√©rification carte: ${checkResponse.status}`);
                
                if (!checkResponse.ok) {
                    log(`‚ùå Carte ID ${selectedVehicule.id} introuvable dans l'API v√©hicules`);
                    document.getElementById('message').innerHTML = `<p class="error">‚ùå V√©hicule ID ${selectedVehicule.id} introuvable</p>`;
                    return;
                }
                
                const carteDetails = await checkResponse.json();
                log(`‚úÖ Carte trouv√©e: ${JSON.stringify(carteDetails)}`);
                
                // V√©rifier que l'utilisateur est bien propri√©taire
                if (carteDetails.proprietaireId !== userId) {
                    log(`‚ùå Propri√©taire incorrect: ${carteDetails.proprietaireId} vs ${userId}`);
                    document.getElementById('message').innerHTML = `<p class="error">‚ùå Vous n'√™tes pas propri√©taire de ce v√©hicule</p>`;
                    return;
                }
                
            } catch (error) {
                log(`‚ùå Erreur v√©rification carte: ${error.message}`);
                document.getElementById('message').innerHTML = `<p class="error">‚ùå Erreur v√©rification: ${error.message}</p>`;
                return;
            }
            
            // Maintenant, cr√©er l'offre
            const offerData = {
                carteId: selectedVehicule.id,
                vendeurId: userId,
                prix: parseFloat(prix),
                active: true
            };
            
            log(`üöó VENTE: ${JSON.stringify(offerData)}`);
            document.getElementById('message').innerHTML = '<p>Cr√©ation de l\'offre...</p>';
            
            try {
                const response = await fetch('/api/market/offres', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(offerData)
                });
                
                log(`üì• R√©ponse vente: ${response.status}`);
                
                if (response.ok) {
                    const result = await response.text();
                    log(`‚úÖ Vente r√©ussie: ${result}`);
                    document.getElementById('message').innerHTML = '<p class="success">‚úÖ Vente r√©ussie!</p>';
                    
                    // Recharger les v√©hicules
                    setTimeout(() => {
                        chargerVehicules();
                        if (confirm('Voir dans le catalogue ?')) {
                            window.location.href = '/catalogue.html';
                        }
                    }, 2000);
                } else {
                    const error = await response.text();
                    log(`‚ùå Erreur vente: ${error}`);
                    document.getElementById('message').innerHTML = `<p class="error">‚ùå ${error}</p>`;
                }
            } catch (error) {
                log(`‚ùå Erreur r√©seau vente: ${error.message}`);
                document.getElementById('message').innerHTML = `<p class="error">‚ùå ${error.message}</p>`;
            }
        }
        
        // Tester les APIs
        async function testerAPIs() {
            log('üîß Test des APIs...');
            
            try {
                // Test 1: API v√©hicules
                const r1 = await fetch('/api/cartes');
                log(`üîß /api/cartes: ${r1.status}`);
                
                // Test 2: API offres actives
                const r2 = await fetch('/api/market/offres/actives');
                log(`üîß /api/market/offres/actives: ${r2.status}`);
                
                if (r2.ok) {
                    const offres = await r2.json();
                    log(`üîß ${offres.length} offres actives trouv√©es`);
                }
                
            } catch (error) {
                log(`üîß Erreur test APIs: ${error.message}`);
            }
        }
    </script>
</body>
</html>