<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Vente de v√©hicules - EKA Motors</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .user-info {
            position: fixed;
            top: 10px;
            right: 10px;
            background: white;
            padding: 10px;
            border-radius: 5px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            z-index: 1000;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        h2 {
            color: #333;
            margin-bottom: 20px;
        }
        button {
            background-color: #4a90e2;
            color: white;
            border: none;
            padding: 10px 15px;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover {
            background-color: #357abd;
        }
        button:disabled {
            background-color: #ccc;
            cursor: not-allowed;
        }
        .content {
            display: flex;
            gap: 20px;
        }
        table {
            flex: 2;
            border-collapse: collapse;
            width: 100%;
        }
        th, td {
            border: 1px solid #ddd;
            padding: 12px;
            text-align: left;
        }
        th {
            background-color: #f4f4f4;
            font-weight: bold;
        }
        tr:hover {
            background-color: #f9f9f9;
        }
        tr.selected {
            background-color: #e3f2fd;
        }
        tr.disabled {
            opacity: 0.6;
            background-color: #f5f5f5;
        }
        #detailsCarte {
            flex: 1;
            background: #f9f9f9;
            padding: 20px;
            border-radius: 8px;
            height: fit-content;
        }
        #detailsCarte img {
            width: 100%;
            max-width: 200px;
            height: auto;
            border-radius: 4px;
            margin-bottom: 10px;
        }
        .price-input {
            margin: 10px 0;
        }
        .price-input input {
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            width: 100px;
        }
        .success { color: green; }
        .error { color: red; }
    </style>
</head>
<body>

<!-- Infos utilisateur + D√©connexion -->
<div class="user-info">
    <span id="solde">0 $</span>
    <span>üë§ <b id="username">Utilisateur</b></span>
    <button onclick="deconnecter()">D√©connexion</button>
</div>

<div class="container">
    <h2>üöó Vente de v√©hicules</h2>

    <!-- Bouton de retour -->
    <button id="retourAccueil">‚¨Ö Retour √† l'accueil</button>
    <button onclick="window.location.href='/catalogue.html'">üîç Voir le catalogue</button>

    <div class="content">
        <!-- Tableau des v√©hicules -->
        <div style="flex: 2;">
            <h3>Mes v√©hicules</h3>
            <table id="cartesTable">
                <thead>
                <tr>
                    <th>Nom</th>
                    <th>Description</th>
                    <th>Raret√©</th>
                    <th>Prix actuel</th>
                    <th>Statut</th>
                </tr>
                </thead>
                <tbody>
                <tr><td colspan="5">Chargement des v√©hicules...</td></tr>
                </tbody>
            </table>
        </div>

        <!-- D√©tails du v√©hicule s√©lectionn√© -->
        <div id="detailsCarte">
            <h3>D√©tails du v√©hicule</h3>
            <img id="imageCarte" src="/images/default-card.png" alt="Aucun v√©hicule s√©lectionn√©">
            <p><b>Nom :</b> <span id="nomCarte">-</span></p>
            <p><b>Description :</b> <span id="descriptionCarte">-</span></p>
            <p><b>Raret√© :</b> <span id="rareteCarte">-</span></p>
            <p><b>Prix actuel :</b> <span id="prixCarte">-</span> $</p>
            
            <div class="price-input">
                <label for="prixVente"><b>Prix de vente :</b></label><br>
                <input type="number" id="prixVente" placeholder="Entrez le prix" min="1" step="100">
                <span> $</span>
            </div>
            
            <button id="vendreCarte" disabled>üí∞ Mettre en vente</button>
            <div id="message"></div>
        </div>
    </div>
</div>

<script>
// Variables globales
let utilisateurId = null;
let selectedCardId = null;

// Initialisation
document.addEventListener("DOMContentLoaded", function () {
    console.log("üöó Page de vente charg√©e");
    
    // Pour l'instant, utilisons l'ID utilisateur 1 par d√©faut
    utilisateurId = 1;
    document.getElementById('username').textContent = 'Test User';
    document.getElementById('solde').textContent = '10000 $';
    
    console.log("üîç Utilisation de l'ID utilisateur:", utilisateurId);
    chargerCartesUtilisateur(utilisateurId);

    // Gestion de la s√©lection de v√©hicule
    document.getElementById("cartesTable").addEventListener("click", function (event) {
        const row = event.target.closest("tr");
        if (row && row.dataset.carteId) {
            // D√©s√©lectionner les autres lignes
            document.querySelectorAll("#cartesTable tbody tr").forEach(r => r.classList.remove("selected"));
            
            // S√©lectionner la ligne cliqu√©e
            row.classList.add("selected");
            selectedCardId = parseInt(row.dataset.carteId);
            
            // Afficher les d√©tails
            afficherDetailsCarte(row);
            
            // Activer le bouton de vente si pas d√©j√† en vente
            const isForSale = row.dataset.avendre === 'true';
            document.getElementById("vendreCarte").disabled = isForSale;
            
            if (isForSale) {
                document.getElementById("message").innerHTML = '<p class="error">Ce v√©hicule est d√©j√† en vente</p>';
            } else {
                document.getElementById("message").innerHTML = '';
            }
        }
    });

    // Gestion du bouton de vente
    document.getElementById("vendreCarte").addEventListener("click", function () {
        const prix = document.getElementById("prixVente").value;
        
        if (!selectedCardId) {
            alert("Veuillez s√©lectionner un v√©hicule !");
            return;
        }

        if (!prix || isNaN(prix) || parseFloat(prix) <= 0) {
            alert("Veuillez entrer un prix valide !");
            return;
        }

        vendreVehicule(selectedCardId, utilisateurId, parseFloat(prix));
    });

    // Bouton de retour
    document.getElementById("retourAccueil").addEventListener("click", function () {
        window.location.href = "/";
    });
});

// Fonction pour charger les v√©hicules de l'utilisateur
async function chargerCartesUtilisateur(userId) {
    console.log("üì• Chargement des v√©hicules pour l'utilisateur", userId);
    
    try {
        const response = await fetch(`/api/cartes/utilisateur/${userId}`);
        
        if (response.ok) {
            const cartes = await response.json();
            console.log("‚úÖ V√©hicules charg√©s:", cartes);
            afficherCartesTable(cartes);
        } else {
            console.error("‚ùå Erreur lors du chargement:", response.status);
            document.querySelector("#cartesTable tbody").innerHTML = 
                '<tr><td colspan="5" class="error">Erreur lors du chargement des v√©hicules</td></tr>';
        }
    } catch (error) {
        console.error("‚ùå Erreur r√©seau:", error);
        document.querySelector("#cartesTable tbody").innerHTML = 
            '<tr><td colspan="5" class="error">Erreur de connexion</td></tr>';
    }
}

// Fonction pour afficher les v√©hicules dans le tableau
function afficherCartesTable(cartes) {
    const tbody = document.querySelector("#cartesTable tbody");
    
    if (cartes.length === 0) {
        tbody.innerHTML = '<tr><td colspan="5">Aucun v√©hicule trouv√©</td></tr>';
        return;
    }

    tbody.innerHTML = cartes.map(carte => `
        <tr data-carte-id="${carte.id}" data-avendre="${carte.avendre}" class="${carte.avendre ? 'disabled' : ''}">
            <td>${carte.nom}</td>
            <td>${carte.description}</td>
            <td>${carte.rarete}</td>
            <td>${carte.prix} $</td>
            <td>${carte.avendre ? 'üè∑Ô∏è En vente' : '‚úÖ Disponible'}</td>
        </tr>
    `).join('');
}

// Fonction pour afficher les d√©tails d'un v√©hicule
function afficherDetailsCarte(row) {
    const carteId = row.dataset.carteId;
    const nom = row.cells[0].textContent;
    const description = row.cells[1].textContent;
    const rarete = row.cells[2].textContent;
    const prix = row.cells[3].textContent;

    document.getElementById("nomCarte").textContent = nom;
    document.getElementById("descriptionCarte").textContent = description;
    document.getElementById("rareteCarte").textContent = rarete;
    document.getElementById("prixCarte").textContent = prix;
    
    // Pr√©-remplir le prix de vente avec le prix actuel
    const prixValue = parseFloat(prix.replace(' $', ''));
    document.getElementById("prixVente").value = prixValue;
}

// Fonction pour vendre un v√©hicule
async function vendreVehicule(carteId, vendeurId, prix) {
    console.log("üöó VENTE: Cr√©ation d'une offre pour la carte", carteId, "utilisateur", vendeurId, "prix", prix);
    
    const offerData = {
        carteId: carteId,
        vendeurId: vendeurId,
        prix: prix,
        active: true
    };
    
    console.log("üì§ VENTE: Donn√©es envoy√©es:", offerData);
    document.getElementById("message").innerHTML = '<p>Cr√©ation de l\'offre en cours...</p>';
    
    try {
        const response = await fetch('/api/market/offres', {
            method: "POST",
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(offerData)
        });
        
        console.log("üì• VENTE: R√©ponse du serveur:", response.status, response.statusText);
        
        if (response.ok) {
            const result = await response.text();
            console.log("‚úÖ VENTE: Succ√®s -", result);
            
            document.getElementById("message").innerHTML = '<p class="success">‚úÖ V√©hicule mis en vente avec succ√®s!</p>';
            
            // Marquer le v√©hicule comme en vente dans le tableau
            const row = document.querySelector(`tr[data-carte-id="${carteId}"]`);
            if (row) {
                row.classList.add("disabled");
                row.dataset.avendre = "true";
                row.cells[4].innerHTML = 'üè∑Ô∏è En vente';
            }
            
            // D√©sactiver le bouton
            document.getElementById("vendreCarte").disabled = true;
            
            // Proposer de voir le catalogue
            setTimeout(() => {
                if (confirm("Voulez-vous voir votre v√©hicule dans le catalogue ?")) {
                    window.location.href = "/catalogue.html";
                }
            }, 2000);
            
        } else {
            const errorText = await response.text();
            console.error("‚ùå VENTE: Erreur -", errorText);
            document.getElementById("message").innerHTML = `<p class="error">‚ùå Erreur: ${errorText}</p>`;
        }
        
    } catch (error) {
        console.error("‚ùå VENTE: Erreur lors de la mise en vente:", error);
        document.getElementById("message").innerHTML = `<p class="error">‚ùå Erreur de connexion: ${error.message}</p>`;
    }
}

// Fonction de d√©connexion
function deconnecter() {
    localStorage.removeItem('userData');
    window.location.href = "/connexion.html";
}
</script>

</body>
</html>